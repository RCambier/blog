<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Cython for fast python</h1><p class="page-description">Trying out cython</p>

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/RCambier/blog/tree/master/_notebooks/2021-10-15-cython.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/blog/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/RCambier/blog/master?filepath=_notebooks%2F2021-10-15-cython.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/blog/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/RCambier/blog/blob/master/_notebooks/2021-10-15-cython.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/blog/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-10-15-cython.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A philosophy I like to follow in Python is "Python is slow, let's code everything and than see if we have any bottleneck we should replace with something else". If you find such bottlenecks, you can replace them with a faster library or another language.</p>
<p>Replacing Python by Cython is one of the ways to speedup such bottlenecks.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's try to code a correlation computation function in cython and compare it to Python or Numpy.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First, the easy numpy version</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="o">%</span><span class="k">timeit</span> np.corrcoef(a,b)
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>947 µs ± 113 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now, a simple pupre Python version.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">correlation</span><span class="p">(</span><span class="n">a_samples</span><span class="p">,</span> <span class="n">b_samples</span><span class="p">):</span> 
  <span class="n">a_mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a_samples</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_samples</span><span class="p">)</span>
  <span class="n">b_mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">b_samples</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_samples</span><span class="p">)</span>

  <span class="n">diff_a_samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="o">-</span> <span class="n">a_mean</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">a_samples</span><span class="p">]</span>
  <span class="n">diff_b_samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="n">b_mean</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">b_samples</span><span class="p">]</span>

  <span class="n">covariance</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">diff_a</span> <span class="o">*</span> <span class="n">diff_b</span> <span class="k">for</span> <span class="n">diff_a</span><span class="p">,</span> <span class="n">diff_b</span>  <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">diff_a_samples</span><span class="p">,</span> <span class="n">diff_b_samples</span><span class="p">)])</span> 
  <span class="n">variance_a</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">diff_a</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">diff_a</span> <span class="ow">in</span> <span class="n">diff_a_samples</span><span class="p">)</span>
  <span class="n">variance_b</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">diff_b</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">diff_b</span> <span class="ow">in</span> <span class="n">diff_b_samples</span><span class="p">)</span>
  <span class="n">correlation</span> <span class="o">=</span> <span class="n">covariance</span> <span class="o">/</span> <span class="p">(</span><span class="n">variance_a</span> <span class="o">*</span> <span class="n">variance_b</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">correlation</span>

<span class="o">%</span><span class="k">timeit</span> correlation(a,b)
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2.38 ms ± 85.8 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's now try to build a version in cython.</p>
<p>First, I have to transform the Python lists in C arrays. 
Then I compute the values one by one, making sure that I don't leave any Python operations.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> cython
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>The cython extension is already loaded. To reload it, use:
  %reload_ext cython
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%</span><span class="n">cython</span>

<span class="k">import</span> <span class="nn">cython</span>

<span class="k">from</span> <span class="nn">libc.stdlib</span> <span class="k">cimport</span> <span class="n">malloc</span><span class="p">,</span> <span class="n">free</span>
<span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">sqrt</span>

<span class="k">def</span> <span class="nf">cython_correlation</span><span class="p">(</span><span class="n">a_samples</span><span class="p">,</span> <span class="n">b_samples</span><span class="p">):</span> 
  <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">a_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_samples</span><span class="p">)</span>
  <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">b_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_samples</span><span class="p">)</span>

  <span class="c"># First we convert the Python lists into C arrays</span>
  <span class="n">a_samples_array</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nb">int</span> <span class="o">*&gt;</span><span class="n">malloc</span><span class="p">(</span><span class="n">a_len</span><span class="o">*</span><span class="n">cython</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">a_samples_array</span> <span class="ow">is</span> <span class="bp">NULL</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">MemoryError</span>
  <span class="n">b_samples_array</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nb">int</span> <span class="o">*&gt;</span><span class="n">malloc</span><span class="p">(</span><span class="n">b_len</span><span class="o">*</span><span class="n">cython</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">b_samples_array</span> <span class="ow">is</span> <span class="bp">NULL</span><span class="p">:</span> 
    <span class="k">raise</span> <span class="ne">MemoryError</span>
  
  <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span> <span class="o">=</span> <span class="mf">0</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a_len</span><span class="p">):</span> 
    <span class="n">a_samples_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">b_samples_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

  <span class="c"># Now we can compute the correlation</span>

  <span class="c"># First compute the sum of the arrays</span>
  <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">a_sum</span> <span class="o">=</span> <span class="mf">0</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a_len</span><span class="p">):</span>
    <span class="n">a_sum</span> <span class="o">+=</span> <span class="n">a_samples_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

  <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">b_sum</span> <span class="o">=</span> <span class="mf">0</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a_len</span><span class="p">):</span>
    <span class="n">b_sum</span> <span class="o">+=</span> <span class="n">b_samples_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

  <span class="c"># Then we can compute the means</span>
  <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">a_mean</span>
  <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">b_mean</span>
  <span class="n">a_mean</span> <span class="o">=</span> <span class="n">a_sum</span> <span class="o">/</span> <span class="n">a_len</span>
  <span class="n">b_mean</span> <span class="o">=</span> <span class="n">b_sum</span> <span class="o">/</span> <span class="n">b_len</span>
  
  <span class="c"># We then put the difference to the means in new arrays</span>
  <span class="n">diff_a_samples</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">double</span> <span class="o">*&gt;</span><span class="n">malloc</span><span class="p">(</span><span class="n">a_len</span><span class="o">*</span><span class="n">cython</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">double</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">diff_a_samples</span> <span class="ow">is</span> <span class="bp">NULL</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">MemoryError</span>
  <span class="n">diff_b_samples</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">double</span> <span class="o">*&gt;</span><span class="n">malloc</span><span class="p">(</span><span class="n">b_len</span><span class="o">*</span><span class="n">cython</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">double</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">diff_b_samples</span> <span class="ow">is</span> <span class="bp">NULL</span><span class="p">:</span> 
    <span class="k">raise</span> <span class="ne">MemoryError</span>

  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a_len</span><span class="p">):</span>
    <span class="n">diff_a_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_samples_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">a_mean</span>
    <span class="n">diff_b_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_samples_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">b_mean</span>

  <span class="c"># This then allows us to easily compute the </span>
  <span class="c"># covariance and variances.  </span>
  <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">covariance</span> <span class="o">=</span> <span class="mf">0</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a_len</span><span class="p">):</span>
    <span class="n">covariance</span> <span class="o">+=</span> <span class="n">diff_a_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff_b_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

  <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">variance_a</span> <span class="o">=</span> <span class="mf">0</span>
  <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">variance_b</span> <span class="o">=</span> <span class="mf">0</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a_len</span><span class="p">):</span>
    <span class="n">variance_a</span> <span class="o">+=</span> <span class="n">diff_a_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2</span>
    <span class="n">variance_b</span> <span class="o">+=</span> <span class="n">diff_b_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2</span>


  <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">correlation</span> <span class="o">=</span> <span class="mf">0</span>
  <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">variance_product</span> <span class="o">=</span> <span class="p">(</span><span class="n">variance_a</span> <span class="o">*</span> <span class="n">variance_b</span><span class="p">)</span>
  <span class="n">correlation</span> <span class="o">=</span> <span class="n">covariance</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">variance_product</span><span class="p">)</span>

  <span class="n">free</span><span class="p">(</span><span class="n">a_samples_array</span><span class="p">)</span>
  <span class="n">free</span><span class="p">(</span><span class="n">b_samples_array</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">correlation</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">timeit</span> cython_correlation(a,b)

<span class="c1"># 10000 loops, best of 5: 154 µs per loop</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Nice! We got a 6X improvement compared to Numpy and 15X improvement compared to pure Python. Pretty cool.</p>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="RCambier/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/programming/2021/10/15/cython.html" hidden></a>
</article>